<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ascend Avoid</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="styles/index.css" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    </head>

    <body>
        <div class="loader"></div>

        <div class="app-root" data-app="ascend-avoid">
            <header class="app-header">
                <h1>Ascend Avoid</h1>

                <div class="score-panel" data-scores="main">
                    <h4>
                        High Score:
                        <span class="score-value" data-score="high">0</span>
                    </h4>
                    <h4>
                        Score:
                        <span class="score-value" data-score="current">0</span>
                    </h4>
                </div>
            </header>

            <main class="game-main" data-section="main">
                <div class="game-area" data-section="game">
                    <div class="canvas-viewport" data-viewport="main">
                        <canvas
                            class="game-canvas"
                            data-canvas="primary"
                            aria-label="Cross the Box game"
                            role="img"
                        ></canvas>
                    </div>

                    <div class="info-panel desktop-only" data-panel="info">
                        <div class="panel-content" data-content="instructions">
                            <h3>How to Play:</h3>
                            <p>
                                Move the white block to the top without hitting
                                the blue blocks.
                            </p>
                            <ul>
                                <li>Use arrow keys or WASD to move</li>
                                <li>Press 'R' to restart the game</li>
                            </ul>
                            <p class="note">
                                Game speed increases as you score more points!
                            </p>
                            <p>
                                Try to beat your high score and challenge your
                                friends in multiplayer mode!
                            </p>
                        </div>
                        <div class="info-actions">
                            <button
                                class="nav-button btn-action"
                                data-action="guide-desktop"
                                aria-label="How to play"
                            >
                                Guide
                            </button>
                            <button
                                class="nav-button btn-action"
                                data-action="multiplayer-desktop"
                                aria-label="Multiplayer mode"
                            >
                                Multiplayer
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <div class="control-panel" data-section="controls">
                <div class="touch-controller" data-controller="main"></div>

                <div class="float-menu mobile-only" data-menu="primary">
                    <div class="float-trigger" data-trigger="menu">
                        <span class="menu-dot"></span>
                        <span class="menu-dot"></span>
                        <span class="menu-dot"></span>
                    </div>
                    <div class="float-options hidden" data-options="menu">
                        <button
                            class="btn-action"
                            data-action="guide"
                            aria-label="How to play"
                            title="How to play"
                        >
                            Guide
                        </button>
                        <button
                            class="btn-action"
                            data-action="multiplayer"
                            aria-label="Multiplayer mode"
                            title="Multiplayer mode"
                        >
                            Multiplayer
                        </button>
                    </div>
                </div>

                <div class="modal-panel mobile-only modal hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>How to Play</h3>
                            <button
                                class="close-modal"
                                aria-label="Close instructions"
                            >
                                Ã—
                            </button>
                        </div>
                        <div class="modal-body">
                            <div
                                class="modal-instructions"
                                data-content="mobile-instructions"
                            >
                                <p>
                                    Move the white block to the top without
                                    hitting the blue blocks.
                                </p>
                                <ul>
                                    <li>Use the D-pad on the left to move</li>
                                    <li>A button: Fire missile</li>
                                    <li>B button: Activate boost</li>
                                </ul>
                                <p class="note">
                                    Game speed increases as you score more
                                    points!
                                </p>
                                <p>
                                    Try to beat your high score and challenge
                                    your friends in multiplayer mode!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="error-panel" data-error="container">
            <h3>Oops! Something went wrong</h3>
            <p class="error-text" data-error="message">
                There was a problem loading the game.
            </p>
            <button onclick="window.location.reload()">Reload Game</button>
        </div>

        <script
            type="module"
            src="index.ts"
            onerror="document.querySelector('.error-panel[data-error=&quot;container&quot;]').style.display='block'; document.querySelector('.error-text[data-error=&quot;message&quot;]').textContent='Failed to load game script. Please check your connection and try again.'"
        ></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const menuButton = document.querySelector('.float-trigger')
                const menuItems = document.querySelector('.float-options')
                const floatMenu = document.querySelector('.float-menu')
                const guideButton = document.querySelector(
                    '.btn-action[data-action="guide"]'
                )
                const multiplayerToggle = document.querySelector(
                    '.btn-action[data-action="multiplayer"]'
                )
                const guideSidebarBtn = document.querySelector(
                    '.btn-action[data-action="guide-desktop"]'
                )
                const multiplayerSidebarBtn = document.querySelector(
                    '.btn-action[data-action="multiplayer-desktop"]'
                )
                const instructionsModal = document.querySelector('.modal-panel')
                const closeModalBtn = document.querySelector('.close-modal')

                function closeMenu() {
                    if (menuItems) {
                        menuItems.classList.add('hidden')
                    }
                }

                function openMenu() {
                    if (menuItems) {
                        menuItems.classList.remove('hidden')
                    }
                }

                if (menuButton && menuItems) {
                    ;['click', 'touchstart'].forEach(eventType => {
                        menuButton.addEventListener(
                            eventType,
                            function (e) {
                                e.preventDefault()
                                e.stopPropagation()

                                if (menuItems.classList.contains('hidden')) {
                                    openMenu()
                                } else {
                                    closeMenu()
                                }
                            },
                            { passive: false }
                        )
                    })
                }

                function openInstructionsModal() {
                    if (instructionsModal) {
                        instructionsModal.classList.remove('hidden')
                        document.body.classList.add('modal-open')
                        closeMenu()
                    }
                }

                if (guideButton) {
                    guideButton.addEventListener('click', openInstructionsModal)
                }

                if (guideSidebarBtn) {
                    guideSidebarBtn.addEventListener(
                        'click',
                        openInstructionsModal
                    )
                }

                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', function () {
                        if (instructionsModal) {
                            instructionsModal.classList.add('hidden')
                            document.body.classList.remove('modal-open')
                        }
                    })
                }

                function toggleMultiplayer() {
                    const game = window.game
                    if (game && typeof game.switchGameMode === 'function') {
                        const newMode = game.isMultiplayerMode
                            ? 'singlePlayer'
                            : 'multiplayer'
                        game.switchGameMode(newMode)
                            .then(() => {
                                console.log(`Switched to ${newMode} mode`)
                                closeMenu()
                            })
                            .catch(err => {
                                console.error(
                                    'Failed to switch game mode:',
                                    err
                                )
                            })
                    }
                }

                if (multiplayerToggle) {
                    multiplayerToggle.addEventListener(
                        'click',
                        toggleMultiplayer
                    )
                }

                if (multiplayerSidebarBtn) {
                    multiplayerSidebarBtn.addEventListener(
                        'click',
                        toggleMultiplayer
                    )
                }

                document.addEventListener('click', function (e) {
                    if (menuItems && !menuItems.classList.contains('hidden')) {
                        if (!e.target.closest('.float-menu')) {
                            closeMenu()
                        }
                    }
                })

                document.addEventListener(
                    'touchstart',
                    function (e) {
                        if (
                            menuItems &&
                            !menuItems.classList.contains('hidden')
                        ) {
                            if (!e.target.closest('.float-menu')) {
                                closeMenu()
                            }
                        }
                    },
                    { passive: true }
                )

                if (instructionsModal) {
                    instructionsModal.addEventListener('click', function (e) {
                        if (e.target === instructionsModal) {
                            instructionsModal.classList.add('hidden')
                            document.body.classList.remove('modal-open')
                        }
                    })
                }

                document.addEventListener(
                    'touchmove',
                    function (e) {
                        if (e.target.closest('.modal-content')) {
                            return
                        }
                        e.preventDefault()
                    },
                    { passive: false }
                )
            })
        </script>
    </body>
</html>
