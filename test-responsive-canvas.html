<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0, minimum-scale=1.0">
    <title>Responsive Canvas Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        
        .app-root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .app-header {
            background: #333;
            padding: 10px 20px;
            text-align: center;
        }
        
        .game-main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .canvas-viewport {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }
        
        .game-canvas {
            display: block;
            background: linear-gradient(45deg, #0a192f 25%, transparent 25%), 
                        linear-gradient(-45deg, #0a192f 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #0a192f 75%), 
                        linear-gradient(-45deg, transparent 75%, #0a192f 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .control-panel {
            background: #444;
            padding: 20px;
            text-align: center;
            min-height: 100px;
        }
        
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }
        
        .test-controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 4px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover { background: #45a049; }
        
        @media (max-width: 768px) {
            .game-main {
                padding: 10px;
            }
            .debug-info {
                position: static;
                margin: 10px;
                max-width: none;
            }
            .test-controls {
                position: static;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-root" data-app="ascend-avoid">
        <header class="app-header">
            <h1>Responsive Canvas Test</h1>
            <p>Testing ResponsiveManager canvas sizing across different screen sizes</p>
        </header>

        <main class="game-main" data-section="main">
            <div class="canvas-viewport" data-viewport="main">
                <canvas
                    id="gameCanvas"
                    class="game-canvas"
                    data-canvas="primary"
                    aria-label="Test canvas"
                    role="img"
                ></canvas>
            </div>
        </main>

        <div class="control-panel" data-section="controls">
            <p>Touch controls area (mobile)</p>
        </div>
    </div>

    <div class="test-controls">
        <h4>Test Controls</h4>
        <button onclick="simulateResize()">Trigger Resize</button>
        <button onclick="simulateMobile()">Simulate Mobile</button>
        <button onclick="simulateDesktop()">Simulate Desktop</button>
        <button onclick="toggleOrientation()">Toggle Orientation</button>
    </div>

    <div class="debug-info" id="debugInfo">
        <h4>Canvas Debug Info</h4>
        <div id="canvasInfo">Initializing...</div>
    </div>

    <script type="module">
        // Import ResponsiveManager (this would normally be bundled)
        // For this test, we'll create a simplified version
        
        class TestResponsiveManager {
            constructor() {
                this.canvas = null;
                this.baseCanvasWidth = 600;
                this.baseCanvasHeight = 700;
                this.isDesktop = this.detectDesktop();
                this.scalingInfo = { widthScale: 1, heightScale: 1, pixelRatio: 1 };
            }
            
            detectDesktop() {
                return window.innerWidth >= 800 && window.innerHeight >= 500;
            }
            
            init(canvas) {
                this.canvas = canvas;
                this.setupEventListeners();
                this.handleResize();
                this.updateDebugInfo();
            }
            
            setupEventListeners() {
                window.addEventListener('resize', () => this.handleResize());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.handleResize(), 100);
                });
            }
            
            handleResize() {
                this.isDesktop = this.detectDesktop();
                this.resizeCanvas();
                this.updateDebugInfo();
                
                if (this.onResize) {
                    this.onResize();
                }
            }
            
            resizeCanvas() {
                if (!this.canvas) return;
                
                const viewport = this.canvas.closest('.canvas-viewport[data-viewport="main"]');
                if (!viewport) {
                    console.warn('Canvas viewport container not found');
                    return;
                }
                
                let availableWidth, availableHeight;
                
                if (this.isDesktop) {
                    // Desktop calculation
                    const gameMain = document.querySelector('.game-main[data-section="main"]');
                    if (gameMain) {
                        const rect = gameMain.getBoundingClientRect();
                        availableWidth = Math.max(rect.width - 40, 600);
                        availableHeight = Math.max(rect.height - 40, 500);
                    } else {
                        availableWidth = Math.max(window.innerWidth - 300, 600);
                        availableHeight = Math.max(window.innerHeight - 200, 500);
                    }
                } else {
                    // Mobile calculation
                    const header = document.querySelector('.app-header');
                    const controls = document.querySelector('.control-panel[data-section="controls"]');
                    
                    const headerHeight = header ? header.offsetHeight : 80;
                    const controlsHeight = controls ? controls.offsetHeight : 120;
                    const margin = 20;
                    
                    availableHeight = Math.max(window.innerHeight - headerHeight - controlsHeight - margin, 250);
                    availableWidth = Math.max(window.innerWidth - margin, 280);
                    availableWidth = Math.min(availableWidth, 800); // Max mobile width
                }
                
                // Calculate scaling
                const widthScale = availableWidth / this.baseCanvasWidth;
                const heightScale = availableHeight / this.baseCanvasHeight;
                const scale = Math.min(widthScale, heightScale);
                
                // Final dimensions
                const canvasWidth = Math.floor(this.baseCanvasWidth * scale);
                const canvasHeight = Math.floor(this.baseCanvasHeight * scale);
                
                // Apply sizing
                this.canvas.style.width = `${canvasWidth}px`;
                this.canvas.style.height = `${canvasHeight}px`;
                this.canvas.style.display = 'block';
                this.canvas.style.margin = '0 auto';
                
                this.canvas.width = canvasWidth;
                this.canvas.height = canvasHeight;
                
                // Update scaling info
                this.scalingInfo = {
                    widthScale: canvasWidth / this.baseCanvasWidth,
                    heightScale: canvasHeight / this.baseCanvasHeight,
                    pixelRatio: 1
                };
                
                console.log(`Canvas resized: ${canvasWidth}×${canvasHeight} (scale: ${this.scalingInfo.widthScale.toFixed(2)})`);
                
                // Draw test pattern
                this.drawTestPattern();
            }
            
            drawTestPattern() {
                const ctx = this.canvas.getContext('2d');
                if (!ctx) return;
                
                // Clear canvas
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw grid
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                
                const gridSize = 50;
                for (let x = 0; x <= this.canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, this.canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y <= this.canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(this.canvas.width, y);
                    ctx.stroke();
                }
                
                // Draw center cross
                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(this.canvas.width / 2 - 50, this.canvas.height / 2);
                ctx.lineTo(this.canvas.width / 2 + 50, this.canvas.height / 2);
                ctx.moveTo(this.canvas.width / 2, this.canvas.height / 2 - 50);
                ctx.lineTo(this.canvas.width / 2, this.canvas.height / 2 + 50);
                ctx.stroke();
                
                // Draw text
                ctx.fillStyle = '#fff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${this.canvas.width}×${this.canvas.height}`, this.canvas.width / 2, this.canvas.height / 2 + 80);
                ctx.fillText(this.isDesktop ? 'DESKTOP' : 'MOBILE', this.canvas.width / 2, this.canvas.height / 2 + 100);
            }
            
            updateDebugInfo() {
                const info = document.getElementById('canvasInfo');
                if (!info) return;
                
                info.innerHTML = `
                    <strong>Canvas Dimensions:</strong><br>
                    CSS: ${this.canvas.style.width} × ${this.canvas.style.height}<br>
                    Canvas: ${this.canvas.width} × ${this.canvas.height}<br>
                    <br>
                    <strong>Viewport:</strong><br>
                    Window: ${window.innerWidth} × ${window.innerHeight}<br>
                    Device: ${this.isDesktop ? 'Desktop' : 'Mobile'}<br>
                    Orientation: ${window.innerWidth > window.innerHeight ? 'Landscape' : 'Portrait'}<br>
                    <br>
                    <strong>Scaling:</strong><br>
                    Width Scale: ${this.scalingInfo.widthScale.toFixed(3)}<br>
                    Height Scale: ${this.scalingInfo.heightScale.toFixed(3)}<br>
                    Pixel Ratio: ${this.scalingInfo.pixelRatio}
                `;
            }
            
            getScalingInfo() {
                return this.scalingInfo;
            }
            
            isDesktopDevice() {
                return this.isDesktop;
            }
        }
        
        // Initialize test
        const canvas = document.getElementById('gameCanvas');
        const responsiveManager = new TestResponsiveManager();
        responsiveManager.init(canvas);
        
        // Test functions
        window.simulateResize = () => {
            responsiveManager.handleResize();
        };
        
        window.simulateMobile = () => {
            // Simulate mobile viewport
            const viewport = document.querySelector('meta[name="viewport"]');
            viewport.content = 'width=375, initial-scale=1.0';
            
            // Manually trigger mobile mode
            Object.defineProperty(window, 'innerWidth', { value: 375, configurable: true });
            Object.defineProperty(window, 'innerHeight', { value: 667, configurable: true });
            
            responsiveManager.handleResize();
        };
        
        window.simulateDesktop = () => {
            // Simulate desktop viewport
            Object.defineProperty(window, 'innerWidth', { value: 1200, configurable: true });
            Object.defineProperty(window, 'innerHeight', { value: 800, configurable: true });
            
            responsiveManager.handleResize();
        };
        
        window.toggleOrientation = () => {
            // Swap width and height
            const oldWidth = window.innerWidth;
            const oldHeight = window.innerHeight;
            
            Object.defineProperty(window, 'innerWidth', { value: oldHeight, configurable: true });
            Object.defineProperty(window, 'innerHeight', { value: oldWidth, configurable: true });
            
            responsiveManager.handleResize();
        };
        
        // Update debug info periodically
        setInterval(() => {
            responsiveManager.updateDebugInfo();
        }, 1000);
        
        console.log('ResponsiveManager test initialized!');
        console.log('✅ Canvas should now be sized correctly for your device');
        console.log('✅ Try resizing the window or rotating your device');
    </script>
</body>
</html>